#!/usr/bin/env bash

if [[ $1 == "" ]]; then
	eww close my-widget
else
	binds=$(hyprctl binds -j | jq -c '[ .[] | select(.submap | contains("'"$1"'")) ]')
	deleted=$(echo "$binds" | jq -c '[ .[] | select(.arg | contains("reset") | not ) ]')
	columns=$(echo "$deleted" | jq 'length / 4' | jq -c 'round')
	if [[ columns -lt 4 ]]; then
		columns=4
	fi
	submapGroup=$(echo "$deleted" | jq -c '[ .[] | select(.dispatcher | contains("submap")) ]')
	submapGroupSorted=$(echo "$submapGroup" | jq -c ' sort_by(.key) ')
	commandGroup=$(echo "$deleted" | jq -c '[ .[] | select(.dispatcher | contains("submap") | not) ]')
	commandGroupSorted=$(echo "$commandGroup" | jq -c ' sort_by(.key) ')
	merged=$(echo "$commandGroupSorted$submapGroupSorted" | jq -s 'reduce .[] as $x ([]; . + $x)')
	grouped=$(echo "$merged" | jq -c '[ _nwise('$columns') ]')
	# echo "$grouped"
	eww open my-widget --arg bindsJson="$grouped"
fi
