#!/usr/bin/env bash

## Author  : Aditya Shakya (adi1090x)
## Github  : @adi1090x
#
## Applets : Volume

# Import Current Theme
theme="$HOME/.config/rofi/volume-ctl.rasi"

# get mouse position
pos=$(hyprctl cursorpos)
x=$(echo "$pos" | cut -d',' -f1 | tr -d ' ')
y=$(echo "$pos" | cut -d',' -f2 | tr -d ' ')

# Adjust offsets so rofi isn't exactly on top of the cursor
xoffset=$((x - 80))
yoffset=$((y + 0))

themeflag="window {x-offset: $xoffset; y-offset: $yoffset;}"

# Volume Info
mixer="$(amixer info Master | grep 'Mixer name' | cut -d':' -f2 | tr -d \',' ')"
speaker="$(amixer get Master | tail -n1 | awk -F ' ' '{print $5}' | tr -d '[]')"
mic="$(amixer get Capture | tail -n1 | awk -F ' ' '{print $5}' | tr -d '[]')"

active=""
urgent=""

# Speaker Info
amixer get Master | grep '\[on\]' &>/dev/null
if [[ "$?" == 0 ]]; then
  active="-a 1"
  stext='Unmute'
  sicon=' '
else
  urgent="-u 1"
  stext='Mute'
  sicon=' '
fi

# Microphone Info
amixer get Capture | grep '\[on\]' &>/dev/null
if [[ "$?" == 0 ]]; then
  [ -n "$active" ] && active+=",3" || active="-a 3"
  mtext='Unmute'
  micon='󰍬'
else
  [ -n "$urgent" ] && urgent+=",3" || urgent="-u 3"
  mtext='Mute'
  micon='󰍭 '
fi

[ -n "$urgent" ] && urgent+=",5" || urgent="-u 5"

# Theme Elements
prompt="S:$stext, M:$mtext"
mesg="$mixer - Speaker: $speaker, Mic: $mic"

list_col='1'
list_row='6'
win_width='180px'

# Options
layout=$(cat ${theme} | grep 'USE_ICON' | cut -d'=' -f2)
if [[ "$layout" == 'NO' ]]; then
  option_1="  Increase"
  option_2="$sicon $stext"
  option_3="  Decrese"
  option_4="$micon $mtext"
  option_5="󰓃 Settings"
  option_6="  Close"
else
  option_1=" "
  option_2="$sicon"
  option_3=" "
  option_4="$micon"
  option_5="󰓃"
  option_6=" "
fi

# Rofi CMD
rofi_cmd() {
  rofi -theme-str "window {width: $win_width; x-offset: $xoffset; y-offset: $yoffset;}" \
    -theme-str "listview {columns: $list_col; lines: $list_row;}" \
    -theme-str 'textbox-prompt-colon {str: "";}' \
    -dmenu \
    -p "$prompt" \
    -mesg "$mesg" \
    ${active} ${urgent} \
    -markup-rows \
    -theme ${theme}
}

# Pass variables to rofi dmenu
run_rofi() {
  echo -e "$option_1\n$option_2\n$option_3\n$option_4\n$option_5\n$option_6" | rofi_cmd
}

# Execute Command
run_cmd() {
  if [[ "$1" == '--opt1' ]]; then
    amixer -Mq set Master,0 5%+ unmute
  elif [[ "$1" == '--opt2' ]]; then
    amixer set Master toggle
  elif [[ "$1" == '--opt3' ]]; then
    amixer -Mq set Master,0 5%- unmute
  elif [[ "$1" == '--opt4' ]]; then
    amixer set Capture toggle
  elif [[ "$1" == '--opt5' ]]; then
    pavucontrol
  elif [[ "$1" == '--opt6' ]]; then
    killall rofi
  fi
}

# Actions
chosen="$(run_rofi)"
case ${chosen} in
$option_1)
  run_cmd --opt1
  ;;
$option_2)
  run_cmd --opt2
  ;;
$option_3)
  run_cmd --opt3
  ;;
$option_4)
  run_cmd --opt4
  ;;
$option_5)
  run_cmd --opt5
  ;;
$option_6)
  run_cmd --opt6
  ;;
esac
